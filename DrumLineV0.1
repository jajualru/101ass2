(require rsound)
(require 2htdp/image)
(require 2htdp/universe)

;
;;;;;;;;;;;;;;;;;;;OUTSIDE CODE;;;;;;;;;;;;;;;;;;;
;
(define ps (make-pstream))

(define PLAY-FRAMES (/ FRAME-RATE 20))

(define (time-to-play? end-frame cur-frame)
  (< (- end-frame cur-frame) MAX-QUEUE-INTERVAL))

(define MAX-QUEUE-INTERVAL (* 3/80 FRAME-RATE))

(define (both a b) b)

(define BOX-HEIGHT 200)
(define BOX-WIDTH 600)

(define CROSSHAIR-LENGTH 30)
(define CROSSHAIR-WIDTH 10)
(define crosshair (place-image (rectangle CROSSHAIR-WIDTH CROSSHAIR-LENGTH "solid" "purple")
                               (/ CROSSHAIR-LENGTH 2) (/ CROSSHAIR-LENGTH 2)
                               (place-image
                                (rectangle CROSSHAIR-LENGTH CROSSHAIR-WIDTH "solid" "purple")
                                (/ CROSSHAIR-LENGTH 2) (/ CROSSHAIR-LENGTH 2)
                                (rectangle CROSSHAIR-LENGTH CROSSHAIR-LENGTH "solid" "light blue"))))

(define SLIDER-BG (rectangle BOX-WIDTH
                             BOX-HEIGHT
                             "solid"
                             "light blue"))

(define (draw-slider ws)
  (place-image crosshair
               (* (ws-slider-x ws)
                  BOX-WIDTH)
               (* (ws-slider-y ws)
                  BOX-HEIGHT)
               SLIDER-BG))

(define TICK-LEN 1/40)

;
;;;;;;;;;;;;;;;;;;;;;NEW CODE;;;;;;;;;;;;;;;;;;;;;
;

; Constants
(define NOTE
  (resample-to-rate
   FRAME-RATE
   kick))

(define NOTE-LENGTH
  (rs-frames NOTE))

(define-struct ws [slider-x slider-y cur-frame end-frame])

(define INITIAL-STATE (make-ws 0 0 0 PLAY-FRAMES))

; Code
(define (song-len slider-x)
  (+ NOTE-LENGTH slider-x))


(define (queue-next-fragment cur-frame frame-to-play)
  (if (< (+ cur-frame PLAY-FRAMES) (rs-frames kick))
      (pstream-queue ps
                     (clip NOTE cur-frame (+ cur-frame PLAY-FRAMES))
                     frame-to-play);;EDITING HERE
      (pstream-queue ps
                     (silence PLAY-FRAMES)
                     frame-to-play)))


(define (tick-fun ws)
  (cond [(time-to-play? (ws-end-frame ws)
                        (pstream-current-frame ps))
         (if (< (song-len (ws-slider-x ws)) (ws-cur-frame ws))
             (both
              (queue-next-fragment
               (ws-cur-frame ws) ;;FIX THIS
               (ws-end-frame ws))
              (make-ws (ws-slider-x ws)
                       (ws-slider-y ws)
                       (+ (ws-cur-frame ws) PLAY-FRAMES)
                       (+ (ws-end-frame ws) PLAY-FRAMES)))
             (both
              (queue-next-fragment
               0
               (+ (ws-end-frame ws) PLAY-FRAMES))
              (make-ws (ws-slider-x ws)
                       (ws-slider-y ws)
                       (+ (ws-cur-frame ws) PLAY-FRAMES)
                       PLAY-FRAMES)))]
        [else ws]))


(define (handle-mouse ws x y event)
  (cond [(string=? event "button-down")
         (make-ws (/ x BOX-WIDTH)
                  (/ y BOX-HEIGHT)
                  (ws-cur-frame ws)
                  (ws-end-frame ws))]
        [(string=? event "drag")
         (make-ws (/ x BOX-WIDTH)
                  (/ y BOX-HEIGHT)
                  (ws-cur-frame ws)
                  (ws-end-frame ws))]
        [else ws]))


;
;;;;;;;;;;;;;;;;;;;TESTING CODE;;;;;;;;;;;;;;;;;;;
;
(define main
  (big-bang INITIAL-STATE
            [on-mouse handle-mouse]
            [on-tick tick-fun TICK-LEN]
            [to-draw draw-slider]))
